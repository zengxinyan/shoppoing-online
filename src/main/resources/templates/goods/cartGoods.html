<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>商城主页</title>
    <!-- Tell the browser to be responsive to screen width -->
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css"
          th:href="@{/bower_components/bootstrap/dist/css/bootstrap.min.css}">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="bower_components/font-awesome/css/font-awesome.min.css"
          th:href="@{/bower_components/font-awesome/css/font-awesome.min.css}">
    <!-- Ionicons -->
    <link rel="stylesheet" href="bower_components/Ionicons/css/ionicons.min.css"
          th:href="@{/bower_components/Ionicons/css/ionicons.min.css}">
    <!-- Theme style -->
    <link rel="stylesheet" href="dist/css/AdminLTE.min.css" th:href="@{/dist/css/AdminLTE.min.css}">
    <!-- AdminLTE Skins. We have chosen the skin-blue for this starter
          page. However, you can choose any other skin. Make sure you
          apply the skin class to the body tag so the changes take effect. -->
    <link rel="stylesheet" href="dist/css/skins/_all-skins.min.css" th:href="@{/dist/css/skins/_all-skins.min.css}">

</head>

<body>
<div class="row">
    <div class="col-xs-12">
        <div class="box">
            <div class="box-body">
                <table>
                    <tr style="font-size: 12px;color:#cacaca;">
                        <td style='width: 40px;'></td>
                        <td style='width: 80px;'>商品信息</td>
                        <td style='width: 350px;'></td>
                        <td style='width: 80px;text-align: center;'>单价</td>
                        <td style='width: 80px;text-align: center;'>数量</td>
                        <td style='width: 80px;text-align: center;'>小计</td>
                        <td style='width: 80px;text-align: center;'>删除</td>
                    </tr>
                    <table id="cart">

                    </table>
                </table>
            </div>
        </div>
    </div>
</div>
<!-- jQuery 3 -->
<script src="bower_components/jquery/dist/jquery.min.js" th:src="@{/bower_components/jquery/dist/jquery.min.js}"></script>
<!-- Bootstrap 3.3.7 -->
<script src="bower_components/bootstrap/dist/js/bootstrap.min.js" th:src="@{/bower_components/bootstrap/dist/js/bootstrap.min.js}"></script>
<!-- AdminLTE App -->
<script src="dist/js/adminlte.min.js" th:src="@{/dist/js/adminlte.min.js}"></script>

<script src="/static/bower_components/bootstrap-table/bootstrap-table.js"
        th:src="@{/bower_components/bootstrap-table/bootstrap-table.js}"></script>
<script src="/static/bower_components/bootstrap-table/locale/bootstrap-table-zh-CN.js"
        th:src="@{/bower_components/bootstrap-table/locale/bootstrap-table-zh-CN.js}"></script>

<script src="/static/bower_components/layer/layer.js"
        th:src="@{/bower_components/layer/layer.js}"></script>


<!-- Optionally, you can add Slimscroll and FastClick plugins.
     Both of these plugins are recommended to enhance the
     user experience. -->
</body>
</html>

<script>

    var cartId = [[${cartId}]];
    var userId = $("#userId").text();

    $.ajax({
        url : "/getCartGoods?cartId="+cartId,
        type : "get",
        dataType : "json",
        async : false,
        success : function(data1){
            var html = "";
            for(var i = 0; i < data1.goodsList.length; i++){
                var goodsId = data1.goodsList[i].id;
                html = html + "<tr style='height: 70px;'><td style='width: 40px;'></td>"
                    + "<td style='width: 80px;'><a href='javascript:void(0);' onclick='goodsInfo("+goodsId+")'>" +
                    "<img style='width: 50px;height: 50px;border: 1px solid #cdd5da' src='"
                    +data1.goodsList[i].image+"' alt=''></a></td><td style='width: 350px;'>" +
                    "<a href='javascript:void(0);' onclick='goodsInfo("+goodsId+")'>"
                    + data1.goodsList[i].name +"</a></td><td style='width: 80px;text-align: center;'>" +
                    "¥"+ data1.goodsList[i].price+"</td><td style='width: 80px;text-align: center;'>" +
                    "<input type='button' value='-' class='jian"+data1.goodsList[i].id+"'"
                    +"style='width: 20px; height: 20px; border-radius:50%;border:0;box-shadow:0px 0px 0px 0.5px #c1c1c1;outline: none;background-color: #fff' "
                    +" onclick='sub("+data1.goodsList[i].id+","+data1.goodsList[i].price+")'>";
                $.ajax({
                    url : "/getQuantity?cartId="+cartId+"&goodsId="+goodsId,
                    type : "get",
                    dataType : "json",
                    async : false,
                    success : function(data2){
                        html = html +" <span id=quantity"+data1.goodsList[i].id+">"+data2 +"</span> <input type='button' value='+' class='add' style='width: 20px; height: 20px; border-radius:50%;border: 0;box-shadow:0px 0px 0px 0.5px #c1c1c1;outline: none;background-color: #fff' "
                            +" onclick='add("+data1.goodsList[i].id+","+data1.goodsList[i].price+")'>"
                            +"</td><td style='width: 80px;text-align: center;'>¥<b id='xiao"+data1.goodsList[i].id+"'>"
                            +data2*data1.goodsList[i].price
                            +"</b></td><td style='width: 80px;text-align: center;'>" +
                            "<input type='button' value='x' class='delete"+data1.goodsList[i].id+"'"
                            +"style='width:20px;height:20px;border-radius:50%;border:0;box-shadow:0px 0px 0px 0.5px #c1c1c1;outline:none;background-color:#fff' "
                            +" onclick='del("+data1.goodsList[i].id+","+data1.goodsList[i].price+")'></td></tr>";
                    }
                });
            }
            $('#cart').html(html);
        }
    });

    function add(goodsId,price){
        $(".jian"+goodsId).removeAttr("disabled");
        var n=$("#quantity"+goodsId).html();
        var num=parseInt(n)+1;
        $("#quantity"+goodsId).html(num);
        $("#xiao"+goodsId).html(num*price);
        $.ajax({
            url : "/updateCart?cartId="+cartId+"&num=1"+"&price="+price+"&flag=1",
            type : "post",
            dataType : "json",
            async:false,
            success : function(){
            },
        });
        $.ajax({
            url : "/updateCartGoods?cartId="+cartId+"&num=1"+"&goodsId="+goodsId+"&flag=1",
            type : "post",
            dataType : "json",
            success : function(){
            },
        });
        $.ajax({
            url : "/selectById?id="+userId,
            type : "get",
            dataType : "json",
            async : false,
            success : function (data) {
                $('#goodsNum').html(data.cart.quantity);
                $('#goodsNum1').html(data.cart.quantity);
                $('#cartTotal').html(data.cart.total);
                var cartId = data.cart.id;
                $('#cartId').html(cartId);
                $.ajax({
                    url : "/getCartGoods?cartId="+cartId,
                    type : "get",
                    dataType : "json",
                    async : false,
                    success : function(data1){
                        var html = "";
                        for(var i = 0; i < data1.goodsList.length; i++){
                            var goodsId = data1.goodsList[i].id;
                            html = html + "<li><a href='javascript:void(0);' onclick='goodsInfo("+goodsId+")'><div style='position: relative;height: 50px'>"
                                + "<div style='position: relative;float: left'>"
                                + "<img style='width: 50px;height: 50px;border: 1px solid #cdd5da' src='"
                                +data1.goodsList[i].image+"' alt=''></div><div style='margin-left: 70px'><h5 style='margin-top: 0;padding-top: 5px'>"
                                + data1.goodsList[i].name +"</h5><h6 style='color: red'><span>¥ </span>"+ data1.goodsList[i].price+"<span style='color:#cacaca;'>";
                            $.ajax({
                                url : "/getQuantity?cartId="+cartId+"&goodsId="+goodsId,
                                type : "get",
                                dataType : "json",
                                async : false,
                                success : function(data2){
                                    html = html + " x " + data2 +"</span></h6></div></div></a></li>";
                                }
                            });
                        }
                        $('#cartGoods').html(html);
                    }
                })
            }
        });
    };

    function sub(goodsId,price){
        var n=$("#quantity"+goodsId).html();
        if(n==1){
            $(".jian"+goodsId).attr("disabled","disabled");
            return ;
        }
        var num=parseInt(n)-1;
        $("#quantity"+goodsId).html(num);
        $("#xiao"+goodsId).html(num*price);
        $.ajax({
            url : "/updateCart?cartId="+cartId+"&num=1"+"&price="+price+"&flag=0",
            type : "post",
            dataType : "json",
            async:false,
            success : function(){
            },
        });
        $.ajax({
            url : "/updateCartGoods?cartId="+cartId+"&num=1"+"&goodsId="+goodsId+"&flag=0",
            type : "post",
            dataType : "json",
            success : function(){
            },
        });
        $.ajax({
            url : "/selectById?id="+userId,
            type : "get",
            dataType : "json",
            async : false,
            success : function (data) {
                $('#goodsNum').html(data.cart.quantity);
                $('#goodsNum1').html(data.cart.quantity);
                $('#cartTotal').html(data.cart.total);
                var cartId = data.cart.id;
                $('#cartId').html(cartId);
                $.ajax({
                    url : "/getCartGoods?cartId="+cartId,
                    type : "get",
                    dataType : "json",
                    async : false,
                    success : function(data1){
                        var html = "";
                        for(var i = 0; i < data1.goodsList.length; i++){
                            var goodsId = data1.goodsList[i].id;
                            html = html + "<li><a href='javascript:void(0);' onclick='goodsInfo("+goodsId+")'><div style='position: relative;height: 50px'>"
                                + "<div style='position: relative;float: left'>"
                                + "<img style='width: 50px;height: 50px;border: 1px solid #cdd5da' src='"
                                +data1.goodsList[i].image+"' alt=''></div><div style='margin-left: 70px'><h5 style='margin-top: 0;padding-top: 5px'>"
                                + data1.goodsList[i].name +"</h5><h6 style='color: red'><span>¥ </span>"+ data1.goodsList[i].price+"<span style='color:#cacaca;'>";
                            $.ajax({
                                url : "/getQuantity?cartId="+cartId+"&goodsId="+goodsId,
                                type : "get",
                                dataType : "json",
                                async : false,
                                success : function(data2){
                                    html = html + " x " + data2 +"</span></h6></div></div></a></li>";
                                }
                            });
                        }
                        $('#cartGoods').html(html);
                    }
                })
            }
        });
    };

    function del(goodsId,price) {
        var n=$("#quantity"+goodsId).html();
        $.ajax({
            url : "/updateCart?cartId="+cartId+"&num="+n+"&price="+price+"&flag=0",
            type : "post",
            dataType : "json",
            async:false,
            success : function(){
            },
        });
        $.ajax({
            url : "/updateCartGoods?cartId="+cartId+"&num="+n+"&goodsId="+goodsId+"&flag=0",
            type : "post",
            dataType : "json",
            async:false,
            success : function(){
            },
        });
        $.ajax({
            url : "/selectById?id="+userId,
            type : "get",
            dataType : "json",
            async : false,
            success : function (data) {
                $('#goodsNum').html(data.cart.quantity);
                $('#goodsNum1').html(data.cart.quantity);
                $('#cartTotal').html(data.cart.total);
                //var cartId = data.cart.id;
               // $('#cartId').html(cartId);
                $.ajax({
                    url : "/getCartGoods?cartId="+cartId,
                    type : "get",
                    dataType : "json",
                    async : false,
                    success : function(data1){
                        var html = "";
                        for(var i = 0; i < data1.goodsList.length; i++){
                            var goodsId = data1.goodsList[i].id;
                            html = html + "<li><a href='javascript:void(0);' onclick='goodsInfo("+goodsId+")'><div style='position: relative;height: 50px'>"
                                + "<div style='position: relative;float: left'>"
                                + "<img style='width: 50px;height: 50px;border: 1px solid #cdd5da' src='"
                                +data1.goodsList[i].image+"' alt=''></div><div style='margin-left: 70px'><h5 style='margin-top: 0;padding-top: 5px'>"
                                + data1.goodsList[i].name +"</h5><h6 style='color: red'><span>¥ </span>"+ data1.goodsList[i].price+"<span style='color:#cacaca;'>";
                            $.ajax({
                                url : "/getQuantity?cartId="+cartId+"&goodsId="+goodsId,
                                type : "get",
                                dataType : "json",
                                async : false,
                                success : function(data2){
                                    html = html + " x " + data2 +"</span></h6></div></div></a></li>";
                                }
                            });
                        }
                        //alert(html);
                        $('#cartGoods').html(html);
                    },
                    error : function () {
                        $('#cartGoods').html("");
                    }
                })
            }
        });
        $.ajax({
            url : "/getCartGoods?cartId="+cartId,
            type : "get",
            dataType : "json",
            async : false,
            success : function(data1){
                var html = "";
                for(var i = 0; i < data1.goodsList.length; i++){
                    var goodsId = data1.goodsList[i].id;
                    html = html + "<tr style='height: 70px;'><td style='width: 40px;'></td>"
                        + "<td style='width: 80px;'><a href='javascript:void(0);' onclick='goodsInfo("+goodsId+")'>" +
                        "<img style='width: 50px;height: 50px;border: 1px solid #cdd5da' src='"
                        +data1.goodsList[i].image+"' alt=''></a></td><td style='width: 350px;'>" +
                        "<a href='javascript:void(0);' onclick='goodsInfo("+goodsId+")'>"
                        + data1.goodsList[i].name +"</a></td><td style='width: 80px;text-align: center;'>" +
                        "¥"+ data1.goodsList[i].price+"</td><td style='width: 80px;text-align: center;'>" +
                        "<input type='button' value='-' class='jian"+data1.goodsList[i].id+"'"
                        +"style='width: 20px; height: 20px; border-radius:50%;border:0;box-shadow:0px 0px 0px 0.5px #c1c1c1;outline: none;background-color: #fff' "
                        +" onclick='sub("+data1.goodsList[i].id+","+data1.goodsList[i].price+")'>";
                    $.ajax({
                        url : "/getQuantity?cartId="+cartId+"&goodsId="+goodsId,
                        type : "get",
                        dataType : "json",
                        async : false,
                        success : function(data2){
                            html = html +" <span id=quantity"+data1.goodsList[i].id+">"+data2 +"</span> <input type='button' value='+' class='add' style='width: 20px; height: 20px; border-radius:50%;border: 0;box-shadow:0px 0px 0px 0.5px #c1c1c1;outline: none;background-color: #fff' "
                                +" onclick='add("+data1.goodsList[i].id+","+data1.goodsList[i].price+")'>"
                                +"</td><td style='width: 80px;text-align: center;'><b>¥"
                                +data2*data1.goodsList[i].price
                                +"</b></td><td style='width: 80px;text-align: center;'>" +
                                "<input type='button' value='x' class='delete"+data1.goodsList[i].id+"'"
                                +"style='width:20px;height:20px;border-radius:50%;border:0;box-shadow:0px 0px 0px 0.5px #c1c1c1;outline:none;background-color:#fff' "
                                +" onclick='del("+data1.goodsList[i].id+","+data1.goodsList[i].price+")'></td></tr>";
                        }
                    });
                }
                $('#cart').html(html);
            },
            error : function () {
                $('#cart').html("");
            }
        });
    }

    function goodsInfo(goodsId) {
        var x = document.getElementById("name");
        x.innerHTML = "商品详情";
        $("#load").load("/getGoodsInfo1?goodsId="+goodsId+"&flag=1");
    };

</script>